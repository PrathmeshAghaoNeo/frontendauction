<!-- Transaction Management Page -->

<!-- Page Header -->
<div *ngIf="loading" class="text-center my-4">
    <div class="spinner-border text-primary" role="status"></div>
  </div>
  
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="text-purple">Manage Transactions</h2>
    
    
  </div>
  
  <!-- Filters -->
<div class="row mb-3">
  <div class="col-md-3">
    <input type="text" class="form-control" [(ngModel)]="searchText" placeholder="Search by Transaction Number or User..." (input)="applyFilters()" />
  </div>
  <div class="col-md-2">
    <select class="form-select" [(ngModel)]="filterTransactionType" (change)="applyFilters()">
      <option [value]="0">All Types</option>
      <option *ngFor="let type of transactionTypes" [value]="type.id">{{ type.name }}</option>
    </select>
  </div>
  <div class="col-md-2">
    <select class="form-select" [(ngModel)]="filterPaymentMethod" (change)="applyFilters()">
      <option [value]="0">All Payment Methods</option>
      <option *ngFor="let method of paymentMethods" [value]="method.id">{{ method.name }}</option>
    </select>
  </div>
  <div class="col-md-2">
    <select class="form-select" [(ngModel)]="filterStatus" (change)="applyFilters()">
      <option [value]="0">All Statuses</option>
      <option *ngFor="let status of statuses" [value]="status.id">{{ status.name }}</option>
    </select>
  </div>
  <div class="col-md-3 text-end">
    <button class="btn custom-purple-btn" [routerLink]="'newtransaction'" routerLinkActive="active">
      Add Transaction
    </button>
  </div>
</div>
  

  <div class="table-responsive">
    <table class="table table-hover shadow-sm border-0 rounded">
      <thead class="table-purple text-white">
        <tr>
          <th>Transaction #</th>
          <th>User</th>
          <th>Amount</th>
          <th>Type</th>
          <th>Payment Method</th>
          <th>Date & Time</th>
          <th>Status</th>
          <th class="text-end">Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let transaction of transactions | paginate: { id: 'transaction', itemsPerPage: itemsPerPage, currentPage: page}">
          <td>{{ transaction.transactionNumber }}</td>
          <td>{{ transaction.userFullName }}</td>
          <td>{{ transaction.amount | currency }}</td>
          <td>{{ transaction.transactionType }}</td>
          <td>{{ transaction.paymentMethod }}</td>
          <td>{{ transaction.transactionDateTime | date: 'dd/MM/yyyy HH:mm' }}</td>
          <!-- Status Badge -->
          <td>
            <span 
              [ngClass]="{
                'badge bg-success': transaction.status === 'Completed',
                'badge bg-warning text-dark': transaction.status === 'Pending',
                'badge bg-danger': transaction.status === 'Failed',
                'badge bg-info': transaction.status === 'Cancelled'
              }" 
              class="px-3 py-2 rounded-pill">
              {{ transaction.status }}
            </span>
          </td>
          <td class="text-end">
            <button class="btn btn-sm btn-outline-primary me-1" (click)="openViewModal(transaction)">
              <i class="bi bi-eye"></i>
            </button>
            <button class="btn btn-sm btn-outline-primary me-1" [routerLink]="['/update-transaction', transaction.transactionId]">
              <i class="bi bi-pencil"></i>
            </button>
            <button class="btn btn-sm btn-outline-danger" (click)="openDeleteModal(transaction)">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        </tr>
      </tbody>
    </table>
    <pagination-controls id="transaction" (pageChange)="page = $event"></pagination-controls>
  </div>
  
  <!-- View Transaction Modal -->
  <ng-template #viewTransactionModal let-modal>
    <div class="modal-header modal-header-purple">
      <h5 class="modal-title text-white">Transaction Details</h5>
      <button type="button" class="btn-close btn-close-white" aria-label="Close" (click)="modal.dismiss()"></button>
    </div>
    <div class="modal-body">
      <div class="row mb-2">
        <div class="col-md-6">
          <label class="form-label required-label">Transaction Number:</label>
          <p class="form-control-plaintext">{{ selectedTransaction?.transactionNumber }}</p>
        </div>
        <div class="col-md-6">
          <label class="form-label required-label">User:</label>
          <p class="form-control-plaintext">{{ selectedTransaction?.userFullName }}</p>
        </div>
        <div class="col-md-6">
          <label class="form-label required-label">Amount:</label>
          <p class="form-control-plaintext">{{ selectedTransaction?.amount | currency }}</p>
        </div>
        <div class="col-md-6">
          <label class="form-label required-label">Transaction Type:</label>
          <p class="form-control-plaintext">{{ selectedTransaction?.transactionType }}</p>
        </div>
        <div class="col-md-6">
          <label class="form-label required-label">Payment Method:</label>
          <p class="form-control-plaintext">{{ selectedTransaction?.paymentMethod }}</p>
        </div>
        <div class="col-md-6">
          <label class="form-label">Card Type:</label>
          <p class="form-control-plaintext">{{ selectedTransaction?.cardType || 'N/A' }}</p>
        </div>
        <div class="col-md-6">
          <label class="form-label">Merchant Transaction ID:</label>
          <p class="form-control-plaintext">{{ selectedTransaction?.merchantTransactionId || 'N/A' }}</p>
        </div>
        <div class="col-md-6">
          <label class="form-label required-label">Date & Time:</label>
          <p class="form-control-plaintext">{{ selectedTransaction?.transactionDateTime | date: 'dd/MM/yyyy HH:mm' }}</p>
        </div>
        <div class="col-md-6">
          <label class="form-label required-label">Status:</label>
          <p class="form-control-plaintext">{{ selectedTransaction?.status }}</p>
        </div>
        <div class="col-md-12">
          <label class="form-label">Notes:</label>
          <p class="form-control-plaintext">{{ selectedTransaction?.notes || 'No notes' }}</p>
        </div>
        <div class="col-md-12" *ngIf="selectedTransaction?.documentUrls?.length">
          <label class="form-label">Documents:</label>
          <div class="mt-2">
            <div *ngFor="let doc of selectedTransaction?.documentUrls; let i = index" class="mb-1">
              <a [href]="doc" target="_blank" class="text-decoration-none">
                <i class="bi bi-file-earmark-text me-1"></i> Document {{ i + 1 }}
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </ng-template>
  
  <!-- Delete Confirmation Modal -->
  <ng-template #deleteTransactionModal let-modal>
    <div class="modal-header bg-danger text-white">
      <h5 class="modal-title">Confirm Deletion</h5>
      <button type="button" class="btn-close btn-close-white" aria-label="Close" (click)="modal.dismiss()"></button>
    </div>
    <div class="modal-body">
      Are you sure you want to delete transaction <strong>{{ selectedTransaction?.transactionNumber }}</strong>?
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" (click)="modal.dismiss()">Cancel</button>
      <button type="button" class="btn btn-danger" (click)="deleteTransactionConfirmed(); modal.close()">Yes, Delete</button>
    </div>
  </ng-template>